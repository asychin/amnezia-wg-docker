# AmneziaWG Docker Server
# VPN server with DPI bypass capabilities

services:
  # VPN Server
  vpn:
    build: .
    container_name: amneziawg-server
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    devices:
      - /dev/net/tun
    networks:
      - amneziawg-net
    ports:
      - "${AWG_PORT:-443}:${AWG_PORT:-443}/udp"
    volumes:
      - ./config:/app/config
      - ./clients:/app/clients
      - /lib/modules:/lib/modules:ro
    environment:
      - AWG_INTERFACE=${AWG_INTERFACE:-awg0}
      - AWG_PORT=${AWG_PORT:-443}
      - AWG_NET=${AWG_NET:-10.13.13.0/24}
      - AWG_SERVER_IP=${AWG_SERVER_IP:-10.13.13.1}
      - AWG_DNS=${AWG_DNS:-8.8.8.8,8.8.4.4}
      - AWG_JC=${AWG_JC:-7}
      - AWG_JMIN=${AWG_JMIN:-50}
      - AWG_JMAX=${AWG_JMAX:-1000}
      - AWG_S1=${AWG_S1:-86}
      - AWG_S2=${AWG_S2:-574}
      - AWG_H1=${AWG_H1:-1}
      - AWG_H2=${AWG_H2:-2}
      - AWG_H3=${AWG_H3:-3}
      - AWG_H4=${AWG_H4:-4}
      - SERVER_PUBLIC_IP=${SERVER_PUBLIC_IP:-auto}
      - CLIENTS_SUBNET=${CLIENTS_SUBNET:-10.13.13.0/24}
      - ALLOWED_IPS=${ALLOWED_IPS:-0.0.0.0/0}
      # Site-to-site VPN (optional)
      - SERVER_SUBNET=${SERVER_SUBNET:-}
      - SERVER_INTERFACE=${SERVER_INTERFACE:-}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "/app/scripts/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      start_period: 60s
      retries: 3

  # Backup sidecar container (starts automatically with VPN)
  backup:
    image: alpine:3.19
    container_name: amneziawg-backup
    volumes:
      - ./config:/data/config:ro
      - ./clients:/data/clients:ro
      - ./backups:/backups
    environment:
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-24h}
      - BACKUP_KEEP=${BACKUP_KEEP:-10}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Backup service started. Interval: $${BACKUP_INTERVAL}, Keep: $${BACKUP_KEEP} backups"
        mkdir -p /backups
        while true; do
          sleep $${BACKUP_INTERVAL}
          BACKUP_FILE="/backups/amneziawg-$$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "Creating backup: $${BACKUP_FILE}"
          tar -czf "$${BACKUP_FILE}" -C /data config clients 2>/dev/null
          if [ -f "$${BACKUP_FILE}" ]; then
            echo "Backup created successfully"
            cd /backups && ls -t amneziawg-*.tar.gz 2>/dev/null | tail -n +$$((BACKUP_KEEP + 1)) | xargs rm -f 2>/dev/null
          else
            echo "Backup failed"
          fi
        done
    restart: unless-stopped
    depends_on:
      - vpn

networks:
  amneziawg-net:
    driver: bridge
