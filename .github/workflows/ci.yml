name: CI

on:
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

env:
  IMAGE_NAME: amneziawg-docker

permissions:
  contents: read
  security-events: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check project structure
        run: |
          REQUIRED_FILES=(
            "Dockerfile"
            "docker-compose.yml"
            "Makefile"
            "README.md"
            "VERSION"
            "scripts/entrypoint.sh"
            "scripts/healthcheck.sh"
            "scripts/manage-clients.sh"
            ".gitmodules"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done
          echo "All required files present"

      - name: Check submodules
        run: |
          if [[ ! -e "amneziawg-go/.git" ]] || [[ ! -e "amneziawg-tools/.git" ]]; then
            echo "Submodules not initialized"
            exit 1
          fi
          echo "Submodules OK"

      - name: Validate docker-compose
        run: docker compose config --quiet

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container startup
        run: |
          sudo mkdir -p /dev/net
          sudo mknod /dev/net/tun c 10 200 2>/dev/null || true
          sudo chmod 666 /dev/net/tun
          
          docker run -d \
            --name test-container \
            --privileged \
            --cap-add=NET_ADMIN \
            --cap-add=SYS_MODULE \
            --device=/dev/net/tun \
            -e AWG_INTERFACE=awg0 \
            -e AWG_PORT=51820 \
            -e AWG_NET=10.13.13.0/24 \
            -e AWG_SERVER_IP=10.13.13.1 \
            -e SERVER_PUBLIC_IP=127.0.0.1 \
            -e AWG_DISABLE_IPTABLES=true \
            ${{ env.IMAGE_NAME }}:test
          
          sleep 30
          
          if ! docker ps | grep -q test-container; then
            docker logs test-container
            exit 1
          fi
          
          docker exec test-container amneziawg-go --version
          docker exec test-container awg --version

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container 2>/dev/null || true
          docker rm test-container 2>/dev/null || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build image
        run: docker build -t ${{ env.IMAGE_NAME }}:security .

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:security
          format: sarif
          output: trivy-results.sarif

      - name: Upload results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
