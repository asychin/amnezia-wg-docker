name: ğŸ”„ Auto Update Dependencies

on:
  # Weekly submodule updates
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 03:00 UTC
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      update_submodules:
        description: 'Update submodules'
        type: boolean
        default: true
      create_pr:
        description: 'Create Pull Request with updates'
        type: boolean
        default: true

jobs:
  update-dependencies:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
      
      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: ğŸ“¦ Check for submodule updates
        id: check_updates
        run: |
          echo "ğŸ” Checking for submodule updates..."
          
          # Save current commits
          AWG_GO_CURRENT=$(cd amneziawg-go && git rev-parse HEAD)
          AWG_TOOLS_CURRENT=$(cd amneziawg-tools && git rev-parse HEAD)
          
          # Update submodules
          git submodule update --remote --recursive
          
          # Check for new commits
          AWG_GO_NEW=$(cd amneziawg-go && git rev-parse HEAD)
          AWG_TOOLS_NEW=$(cd amneziawg-tools && git rev-parse HEAD)
          
          UPDATES_FOUND=false
          CHANGELOG=""
          
          if [[ "$AWG_GO_CURRENT" != "$AWG_GO_NEW" ]]; then
            echo "ğŸ“¦ amneziawg-go update: $AWG_GO_CURRENT -> $AWG_GO_NEW"
            UPDATES_FOUND=true
            CHANGELOG="$CHANGELOG- ğŸ“¦ Update amneziawg-go to commit ${AWG_GO_NEW:0:8}\n"
            
            # Get changes list
            cd amneziawg-go
            CHANGES=$(git log --oneline $AWG_GO_CURRENT..$AWG_GO_NEW | head -5)
            if [[ -n "$CHANGES" ]]; then
              CHANGELOG="$CHANGELOG  Changes in amneziawg-go:\n"
              while IFS= read -r line; do
                CHANGELOG="$CHANGELOG  - $line\n"
              done <<< "$CHANGES"
            fi
            cd ..
          fi
          
          if [[ "$AWG_TOOLS_CURRENT" != "$AWG_TOOLS_NEW" ]]; then
            echo "ğŸ“¦ amneziawg-tools update: $AWG_TOOLS_CURRENT -> $AWG_TOOLS_NEW"
            UPDATES_FOUND=true
            CHANGELOG="$CHANGELOG- ğŸ“¦ Update amneziawg-tools to commit ${AWG_TOOLS_NEW:0:8}\n"
            
            # Get changes list
            cd amneziawg-tools
            CHANGES=$(git log --oneline $AWG_TOOLS_CURRENT..$AWG_TOOLS_NEW | head -5)
            if [[ -n "$CHANGES" ]]; then
              CHANGELOG="$CHANGELOG  Changes in amneziawg-tools:\n"
              while IFS= read -r line; do
                CHANGELOG="$CHANGELOG  - $line\n"
              done <<< "$CHANGES"
            fi
            cd ..
          fi
          
          echo "updates_found=$UPDATES_FOUND" >> $GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [[ "$UPDATES_FOUND" == "true" ]]; then
            echo "âœ… Dependency updates found"
          else
            echo "â„¹ï¸ No updates found"
          fi
      
      - name: ğŸ§ª Test after updates
        if: steps.check_updates.outputs.updates_found == 'true'
        run: |
          echo "ğŸ§ª Testing project after updates..."
          
          # Test build
          docker build -t amneziawg-update-test .
          
          # Quick test
          docker run --rm amneziawg-update-test amneziawg-go --version
          docker run --rm amneziawg-update-test awg --version
          
          echo "âœ… Tests passed successfully"
      
      - name: ğŸ“ Create Pull Request
        if: steps.check_updates.outputs.updates_found == 'true' && (github.event.inputs.create_pr != 'false')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”„ Automatic dependency updates
            
            ${{ steps.check_updates.outputs.changelog }}
          title: 'ğŸ”„ Automatic dependency updates'
          body: |
            ## ğŸ”„ Automatic Dependency Updates
            
            This PR contains automatic updates of AmneziaWG submodules.
            
            ### ğŸ“¦ Updates:
            ${{ steps.check_updates.outputs.changelog }}
            
            ### âœ… Checks:
            - [x] Docker image builds successfully
            - [x] Basic tests completed
            - [x] Component versions verified
            
            ### ğŸš€ Next Steps:
            1. Review changes in submodules
            2. Run additional tests if needed
            3. Merge PR to apply updates
            
            ---
            ğŸ¤– *This PR was created automatically by GitHub Actions*
          branch: auto-update/dependencies
          delete-branch: true
          draft: false
      
      - name: ğŸ“Š Update report
        run: |
          echo "ğŸ”„ AUTOMATIC UPDATE REPORT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Updates found: ${{ steps.check_updates.outputs.updates_found }}"
          
          if [[ "${{ steps.check_updates.outputs.updates_found }}" == "true" ]]; then
            echo "ğŸ“ Changelog:"
            echo -e "${{ steps.check_updates.outputs.changelog }}"
            echo "ğŸ”§ Pull Request will be created automatically"
          else
            echo "â„¹ï¸ All dependencies are up to date"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"