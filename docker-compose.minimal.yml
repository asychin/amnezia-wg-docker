# AmneziaWG Docker VPN Server - Минимальная конфигурация (v1.x совместимость)
# 
# Этот файл предоставляет минимальную конфигурацию для запуска только VPN сервера
# без веб-интерфейса и PostgreSQL базы данных.
#
# Использование:
#   docker compose -f docker-compose.minimal.yml up -d
#   
# Эта конфигурация 100% совместима с v1.x и не требует дополнительных зависимостей.

services:
  # AmneziaWG VPN Server (только VPN, без веб-интерфейса)
  vpn:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        AMNEZIAWG_GO_VERSION: ${AMNEZIAWG_GO_VERSION:-1.0.20241114}
        AMNEZIAWG_TOOLS_VERSION: ${AMNEZIAWG_TOOLS_VERSION:-1.0.20241112}
    image: amneziawg-server:${VERSION:-latest}
    container_name: amneziawg-server
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - ./config:/etc/amneziawg:rw
      - ./clients:/app/clients:rw
      - /lib/modules:/lib/modules:ro
    ports:
      - "${AWG_PORT:-51820}:${AWG_PORT:-51820}/udp"
    environment:
      # Основные настройки VPN
      - AWG_INTERFACE=${AWG_INTERFACE:-awg0}
      - AWG_PORT=${AWG_PORT:-51820}
      - AWG_NET=${AWG_NET:-10.13.13.0/24}
      - AWG_SERVER_IP=${AWG_SERVER_IP:-10.13.13.1}
      - AWG_DNS=${AWG_DNS:-8.8.8.8,8.8.4.4}
      
      # Параметры обфускации AmneziaWG для обхода DPI
      - AWG_JC=${AWG_JC:-7}
      - AWG_JMIN=${AWG_JMIN:-50}
      - AWG_JMAX=${AWG_JMAX:-1000}
      - AWG_S1=${AWG_S1:-86}
      - AWG_S2=${AWG_S2:-574}
      - AWG_H1=${AWG_H1:-1}
      - AWG_H2=${AWG_H2:-2}
      - AWG_H3=${AWG_H3:-3}
      - AWG_H4=${AWG_H4:-4}
      
      # Настройки сервера
      - SERVER_PUBLIC_IP=${SERVER_PUBLIC_IP:-auto}
      - CLIENTS_SUBNET=${CLIENTS_SUBNET:-10.13.13.0/24}
      - ALLOWED_IPS=${ALLOWED_IPS:-0.0.0.0/0}
      
      # Настройки хелсчека
      - HEALTHCHECK_TIMEOUT=${HEALTHCHECK_TIMEOUT:-5}
      - HEALTHCHECK_VERBOSE=${HEALTHCHECK_VERBOSE:-false}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "/app/scripts/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      start_period: 60s
      retries: 3
