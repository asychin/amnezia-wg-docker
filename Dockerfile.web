# Multi-stage Dockerfile для Web Interface
# Stage 1: Dependencies и Build
FROM node:20-alpine AS builder

WORKDIR /app

# Копируем package files
COPY package*.json ./
COPY tsconfig.json ./
COPY vite.config.ts ./
COPY tailwind.config.ts ./
COPY postcss.config.js ./
COPY drizzle.config.ts ./

# Устанавливаем все зависимости
RUN npm ci

# Копируем весь проект (кроме node_modules - см. .dockerignore)
COPY . .

# Создаем index.html ТОЛЬКО если его нет (fallback для обратной совместимости)
RUN if [ ! -f index.html ]; then \
    echo "⚠️  index.html не найден - создаем fallback версию" && \
    cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="ru" class="light">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light" />
    <title>AmneziaWG VPN Management</title>
  </head>
  <body class="antialiased">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
EOF
fi

# Собираем фронтенд
RUN npm run build

# Stage 2: Production Runtime
FROM node:20-alpine

WORKDIR /app

# Копируем package files для production dependencies
COPY package*.json ./

# Устанавливаем только production dependencies
RUN npm ci --omit=dev

# Копируем необходимые файлы для production
COPY env.example README.md VERSION ./
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/server ./server
COPY --from=builder /app/shared ./shared
COPY --from=builder /app/views ./views

# Устанавливаем curl для healthcheck
RUN apk add --no-cache curl

# Открываем порт
EXPOSE 3001

# Запускаем веб-сервер
CMD ["npm", "run", "start:prod"]
