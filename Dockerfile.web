# Multi-stage Dockerfile для Web Interface
# Stage 1: Dependencies и Build
FROM node:20-alpine AS builder

WORKDIR /app

# Копируем package files
COPY package*.json ./
COPY tsconfig.json ./
COPY vite.config.ts ./
COPY tailwind.config.ts ./
COPY postcss.config.js ./
COPY drizzle.config.ts ./

# Устанавливаем все зависимости
RUN npm ci

# Копируем весь проект (кроме node_modules - см. .dockerignore)
COPY . .

# Создаем index.html ТОЛЬКО если его нет (fallback для обратной совместимости)
RUN if [ ! -f index.html ]; then \
    echo "⚠️  index.html не найден - создаем fallback версию" && \
    echo '<!DOCTYPE html>' > index.html && \
    echo '<html lang="ru" class="light">' >> index.html && \
    echo '  <head>' >> index.html && \
    echo '    <meta charset="UTF-8" />' >> index.html && \
    echo '    <link rel="icon" type="image/svg+xml" href="/vite.svg" />' >> index.html && \
    echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0" />' >> index.html && \
    echo '    <meta name="color-scheme" content="light" />' >> index.html && \
    echo '    <title>AmneziaWG VPN Management</title>' >> index.html && \
    echo '  </head>' >> index.html && \
    echo '  <body class="antialiased">' >> index.html && \
    echo '    <div id="root"></div>' >> index.html && \
    echo '    <script type="module" src="/src/main.tsx"></script>' >> index.html && \
    echo '  </body>' >> index.html && \
    echo '</html>' >> index.html; \
fi

# Собираем фронтенд
RUN npm run build

# Stage 2: Production Runtime
FROM node:20-alpine

WORKDIR /app

# Копируем package files для production dependencies
COPY package*.json ./

# Устанавливаем только production dependencies
RUN npm ci --omit=dev

# Копируем необходимые файлы для production
COPY env.example README.md VERSION ./
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/server ./server
COPY --from=builder /app/shared ./shared
COPY --from=builder /app/views ./views

# Устанавливаем curl для healthcheck
RUN apk add --no-cache curl

# Открываем порт
EXPOSE 3001

# Запускаем веб-сервер
CMD ["npm", "run", "start:prod"]
